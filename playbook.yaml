- name: Configure EC2 instance
  hosts: all
  remote_user: ec2-user
  become: yes
  gather_facts: false

  tasks:
    - name: Wait for SSH to become available
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 10

    - name: Ensure Apache is installed
      yum:
        name: httpd
        state: present

    - name: Start and enable Apache
      service:
        name: httpd
        state: started
        enabled: true

    - name: Create SMBC Bank-themed HTML page for pipeline demo
      copy:
        dest: /var/www/html/index.html
        content: |
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>SMBC Bank | CI/CD Pipeline Demo</title>
            <style>
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                background-color: #f5f6f7;
                color: #333;
              }
              header {
                background-color: #006341; /* SMBC green */
                color: white;
                padding: 20px 40px;
                display: flex;
                justify-content: space-between;
                align-items: center;
              }
              header h1 {
                margin: 0;
                font-size: 1.8rem;
              }
              header img {
                height: 50px;
              }
              main {
                text-align: center;
                padding: 60px 20px;
              }
              h2 {
                color: #006341;
                margin-bottom: 10px;
              }
              .pipeline {
                background: white;
                margin: 40px auto;
                max-width: 800px;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
                text-align: left;
              }
              .pipeline h3 {
                color: #d4af37; /* SMBC gold accent */
                border-bottom: 2px solid #006341;
                padding-bottom: 5px;
              }
              footer {
                background: #003820;
                color: #ccc;
                padding: 15px 20px;
                text-align: center;
                font-size: 0.9em;
              }
              .badge {
                display: inline-block;
                background: #d4af37;
                color: #003820;
                padding: 3px 10px;
                border-radius: 5px;
                font-weight: bold;
                font-size: 0.85em;
                margin-right: 6px;
              }
            </style>
          </head>
          <body>
            <header>
              <h1>SMBC Bank – CI/CD Pipeline Demo</h1>
              <img src="https://upload.wikimedia.org/wikipedia/en/0/0a/SMBC_logo.svg" alt="SMBC Bank Logo" />
            </header>

            <main>
              <h2>Automating Secure & Compliant Deployments</h2>
              <p>This demo showcases a fully automated CI/CD pipeline built for <strong>SMBC Bank</strong>, highlighting secure infrastructure provisioning, policy-as-code, and end-to-end delivery to AWS.</p>

              <div class="pipeline">
                <h3>Pipeline Overview</h3>
                <ul>
                  <li><span class="badge">1</span> <strong>Source:</strong> Code committed to GitHub triggers Jenkins.</li>
                  <li><span class="badge">2</span> <strong>Build:</strong> Docker image created and scanned for vulnerabilities.</li>
                  <li><span class="badge">3</span> <strong>Infrastructure:</strong> Terraform provisions cloud resources following SMBC compliance standards.</li>
                  <li><span class="badge">4</span> <strong>Configuration:</strong> Ansible applies security-hardened configurations.</li>
                  <li><span class="badge">5</span> <strong>Deploy:</strong> Application deployed across environments (Dev → Test → Prod).</li>
                  <li><span class="badge">6</span> <strong>Monitor:</strong> Logs, metrics, and alerts integrated with CloudWatch.</li>
                </ul>
              </div>

              <p><em>Version:</em> 1.0 – <em>Deployed on:</em> <script>document.write(new Date().toLocaleDateString());</script></p>
            </main>

            <footer>
              &copy; <script>document.write(new Date().getFullYear());</script> SMBC Bank. Demonstration project for DevOps/CI-CD best practices.
            </footer>
          </body>
          </html>
      notify:
        - Reload Apache

    - name: Get IMDSv2 token
      uri:
        url: http://169.254.169.254/latest/api/token
        method: PUT
        headers:
          X-aws-ec2-metadata-token-ttl-seconds: "21600"
        return_content: true
      register: imds_token
      changed_when: false

    - name: Get AWS public IP using token
      uri:
        url: http://169.254.169.254/latest/meta-data/public-ipv4
        method: GET
        headers:
          X-aws-ec2-metadata-token: "{{ imds_token.content }}"
        return_content: true
      register: aws_ip
      changed_when: false

    - name: Display AWS public IP
      debug:
        var: aws_ip.content

  handlers:
    - name: Reload Apache
      service:
        name: httpd
        state: reloaded
